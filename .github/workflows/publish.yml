- name: Bump Versions (Smart Patch)
  id: bump
  run: |
    # 1. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ðµ
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ HEAD~1, Ñ‚Ð°Ðº ÐºÐ°Ðº checkout fetch-depth: 0 Ð´Ð°ÐµÑ‚ Ð½Ð°Ð¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
    CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

    echo "Changed files in last commit:"
    echo "$CHANGED_FILES"

    CHANGED=false
    FILTERS=""

    # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð°Ñ…

    # Contracts
    if echo "$CHANGED_FILES" | grep -q "packages/contracts/"; then
       echo "ðŸ“¦ Detected changes in @coolcinema/contracts"
       FILTERS="$FILTERS --filter @coolcinema/contracts"
       CHANGED=true
    fi

    # Foundation
    if echo "$CHANGED_FILES" | grep -q "packages/foundation/"; then
       echo "ðŸ“¦ Detected changes in @coolcinema/foundation"
       FILTERS="$FILTERS --filter @coolcinema/foundation"
       CHANGED=true
    fi

    # CLI
    if echo "$CHANGED_FILES" | grep -q "packages/cli/"; then
       echo "ðŸ“¦ Detected changes in @coolcinema/cli"
       FILTERS="$FILTERS --filter @coolcinema/cli"
       CHANGED=true
    fi

    # 3. ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
    if [ "$CHANGED" = "true" ]; then
       echo "ðŸš€ Bumping versions with filters: $FILTERS"
       
       # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ bump Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
       pnpm $FILTERS exec npm version patch --no-git-tag-version
       
       # Ð’Ñ‹ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ output Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð¾Ð²
       echo "changed=true" >> $GITHUB_OUTPUT
       echo "filter=$FILTERS" >> $GITHUB_OUTPUT
    else
       echo "ðŸ’¤ No relevant packages changed."
       echo "changed=false" >> $GITHUB_OUTPUT
    fi
